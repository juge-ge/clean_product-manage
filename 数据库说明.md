# 数据库说明（SQLite）

## 基本信息
- **数据库文件**: `db.sqlite3`
- **数据库引擎**: SQLite
- **命名规范**: 业务表采用小写+下划线；时间字段为 `created_at`、`updated_at`，大部分表主键为自增 `id`
- **索引策略**: 结合高频查询字段（外键、业务筛选字段、时间字段）建立普通索引；对唯一约束采用唯一索引

> 说明：以下为当前实例中已创建且扫描到的主要表结构（不含系统表 `sqlite_%`）；字段“小标题”即该表的列清单及含义摘要；索引为 `PRAGMA index_list` 与 `PRAGMA index_info` 的综合结果。

---

## 表：`pcb_water_consumption_record`（PCB企业用水消耗记录）
- **用途**: 记录企业各项目年度用水量及来源信息
- **主键**: `id`
- **字段（小标题）**:
  - `id` INTEGER 自增主键
  - `created_at` TIMESTAMP 创建时间
  - `updated_at` TIMESTAMP 更新时间
  - `enterprise_id` BIGINT 企业ID
  - `project` VARCHAR(100) 用水项目名称
  - `unit` VARCHAR(20) 计量单位
  - `amount_2020` ~ `amount_2024` DECIMAL 各年度用水量
  - `water_type` VARCHAR(50) 用水类型
  - `source` VARCHAR(200) 用水来源
  - `remark` TEXT 备注
- **索引**:
  - `idx_pcb_water_c_project_ca5404` (project)
  - `idx_pcb_water_c_enterpr_993536` (enterprise_id)
  - `idx_pcb_water_c_created_9605bd` (created_at)
  - `idx_pcb_water_c_updated_34884c` (updated_at)

---

## 表：`pcb_work_plans`（PCB审核工作计划）
- **用途**: 审核阶段计划与进度管理
- **主键**: `id`
- **字段（小标题）**:
  - `id`, `created_at`, `updated_at`
  - `enterprise_id` INT 企业ID
  - `stage_order` INT 阶段顺序（1-10）
  - `stage` VARCHAR(100) 阶段名称
  - `work_content` TEXT 工作内容
  - `planned_start_date`/`planned_end_date` TIMESTAMP 计划时间
  - `responsible_department` VARCHAR(100) 责任部门
  - `actual_start_date`/`actual_end_date` TIMESTAMP 实际时间
- **索引**:
  - `idx_work_plans_enterprise` (enterprise_id)
  - `idx_work_plans_enterprise_stage` UNIQUE (enterprise_id, stage_order)
  - `idx_pcb_work_pl_created_e8a833` (created_at)
  - `idx_pcb_work_pl_updated_e758e7` (updated_at)

---

## 表：`pcb_work_team`（PCB清洁生产工作小组）
- **用途**: 存储企业清洁生产工作小组成员信息
- **主键**: `id`
- **字段（小标题）**:
  - `id`, `created_at`, `updated_at`
  - `enterprise_id` INT 企业ID
  - `name` VARCHAR(100) 姓名
  - `position`/`department` 职位/部门
  - `role` VARCHAR(50) 角色（组长/副组长/成员）
  - `responsibilities` TEXT 职责
  - `phone` VARCHAR(20) 联系电话
- **索引**:
  - `idx_work_team_enterprise_role` (enterprise_id, role)
  - `idx_pcb_work_te_enterpr_7c1272` (enterprise_id)
  - `idx_pcb_work_te_created_7ead72` (created_at)
  - `idx_pcb_work_te_updated_c73c75` (updated_at)

---

## 表：`raw_materials`（原辅材料库）
- **用途**: 原辅材料基础数据字典
- **主键**: `id`
- **字段（小标题）**:
  - `id`, `created_at`, `updated_at`
  - `name` VARCHAR(200) 材料名称
  - `unit` VARCHAR(50) 计量单位
  - `process` VARCHAR(100) 工序
  - `category` VARCHAR(100) 分类
  - `description` TEXT 描述
  - `is_active` BOOLEAN 是否启用
- **索引**:
  - 业务筛选：`idx_raw_materials_name` (name), `idx_raw_materials_process` (process), `idx_raw_materials_category` (category)
  - 系统生成：`idx_raw_materia_*` 若干（name/process/category/unit/created_at/updated_at）

---

## 表：`role`（角色）
- **用途**: RBAC 角色定义
- **主键**: `id`
- **字段（小标题）**:
  - `id`, `created_at`, `updated_at`
  - `name` VARCHAR(20) 角色名（唯一）
  - `desc` VARCHAR(500) 角色描述
- **索引**:
  - `sqlite_autoindex_role_1` UNIQUE (name)
  - `idx_role_name_e5618b` (name)
  - `idx_role_created_7f5f71` (created_at), `idx_role_updated_5dd337` (updated_at)

---

## 表：`role_api`（角色-API 权限关联）
- **用途**: 角色可访问的 API 清单（多对多）
- **主键**: 无（通过唯一索引约束）
- **字段（小标题）**:
  - `role_id` BIGINT 角色ID → `role.id`
  - `api_id` BIGINT API ID → `api.id`
- **外键**:
  - (`role_id`) → `role(id)` ON DELETE CASCADE
  - (`api_id`) → `api(id)` ON DELETE CASCADE
- **索引**:
  - `uidx_role_api_role_id_ba4286` UNIQUE (role_id, api_id)

---

## 表：`role_menu`（角色-菜单 权限关联）
- **用途**: 角色可见菜单清单（多对多）
- **主键**: 无（通过唯一索引约束）
- **字段（小标题）**:
  - `role_id` BIGINT → `role.id`
  - `menu_id` BIGINT → `menu.id`
- **外键**:
  - (`role_id`) → `role(id)` ON DELETE CASCADE
  - (`menu_id`) → `menu(id)` ON DELETE CASCADE
- **索引**:
  - `uidx_role_menu_role_id_90801c` UNIQUE (role_id, menu_id)

---

## 表：`user`（用户）
- **用途**: 系统用户
- **主键**: `id`
- **字段（小标题）**:
  - `id`, `created_at`, `updated_at`
  - `username` VARCHAR(20)（唯一）
  - `alias` VARCHAR(30)
  - `email` VARCHAR(255)（唯一）
  - `phone` VARCHAR(20)
  - `password` VARCHAR(128)
  - `is_active` INT 是否启用
  - `is_superuser` INT 是否超级管理员
  - `last_login` TIMESTAMP 最后登录时间
  - `dept_id` INT 部门ID
- **索引**:
  - 唯一：`sqlite_autoindex_user_1` (username), `sqlite_autoindex_user_2` (email)
  - 查询优化：`idx_user_usernam_9987ab` (username), `idx_user_email_1b4f1c` (email), `idx_user_phone_4e3ecc` (phone)
  - 过滤/排序：`idx_user_is_acti_83722a` (is_active), `idx_user_is_supe_b8a218` (is_superuser), `idx_user_dept_id_d4490b` (dept_id)
  - 时间：`idx_user_created_b19d59` (created_at), `idx_user_last_lo_af118a` (last_login), `idx_user_updated_dfdb43` (updated_at)

---

## 表：`user_role`（用户-角色 关联）
- **用途**: 用户的角色授权（多对多）
- **主键**: 无（通过唯一索引约束）
- **字段（小标题）**:
  - `user_id` BIGINT → `user.id`
  - `role_id` BIGINT → `role.id`
- **外键**:
  - (`user_id`) → `user(id)` ON DELETE CASCADE
  - (`role_id`) → `role(id)` ON DELETE CASCADE
- **索引**:
  - `uidx_user_role_user_id_d0bad3` UNIQUE (user_id, role_id)

---

## 索引设计说明（通用原则）
- **唯一性**: 用户名、邮箱、角色名等具备业务唯一性的字段以唯一索引保证数据一致性
- **外键/连接键**: `enterprise_id`、`role_id`、`user_id`、`menu_id` 等高频连接字段建立普通索引以优化 JOIN/过滤
- **时间维度**: `created_at`/`updated_at` 常用于排序与区间过滤，普遍建立索引
- **业务筛选**: 诸如 `project`、`role`、`stage_order`、`process`、`category` 等常用筛选维度建立覆盖索引

> 注：SQLite 不强制外键约束默认开启，如需强一致建议在连接后执行 `PRAGMA foreign_keys=ON;`。

---

## 其余主要表概览（补充）

> 下列为本库其余已创建业务表的精简说明，列出用途、关键字段（小标题）与索引要点，便于整体把握；如需完整列定义可据此执行 PRAGMA 进一步查询。

### 表：`api`
- **用途**: 系统已注册的API元信息（用于权限、审计）
- **关键字段**: `path`, `method`, `summary`, `tags`, 时间戳
- **索引**: `idx_api_path_*`(path), `idx_api_method_*`(method), `idx_api_summary_*`(summary), `idx_api_tags_*`(tags), 时间索引

### 表：`auditlog`
- **用途**: HTTP审计日志
- **关键字段**: `user_id`, `username`, `module`, `summary`, `method`, `path`, `status`, `response_time`, `request_args`, `response_body`
- **索引**: 用户/模块/方法/路径/状态/响应时长及时间字段的多列索引

### 表：`dept`、`deptclosure`
- **用途**: 部门与部门树闭包表（层级结构）
- **关键字段**: `name`(唯一), `parent_id`/`ancestor`/`descendant`, `level`, `order`
- **索引**: `name`唯一；父子/层级/顺序与时间字段索引

### 表：`menu`
- **用途**: 系统菜单配置
- **关键字段**: `name`, `path`, `menu_type`, `icon`, `component`, `parent_id`, `order`, `is_hidden`
- **索引**: `name`/`path`/`parent_id`/`order` 及时间索引

### 表：`enterprise_raw_material_usage`
- **用途**: 企业原辅材料年用量
- **关键字段**: `enterprise_id`, `material_id`, `year`, `amount`, `unit`, `process`, `state`, `voc_content`
- **索引**: `enterprise_id`/`material_id`/`year` 及时间索引

### 表：`pcb_audit_report`、`pcb_audit_reports`
- **用途**: 审核报告（摘要/编号版）
- **关键字段**: `enterprise_id`, `total_score`, `overall_level`, `status`, `report_number`(唯一, 在 `pcb_audit_reports`)
- **索引**: `enterprise_id`/`status` 及时间索引，`report_number`唯一

### 表：`pcb_audit_result`、`pcb_audit_results`
- **用途**: 企业-指标审核结果
- **关键字段**: `enterprise_id`, `indicator_id`, `level`, `score`, `manual_override`
- **索引**: (`enterprise_id`,`indicator_id`) 唯一；`level`、时间索引

### 表：`pcb_electricity_consumption_record`
- **用途**: 用电消耗记录
- **关键字段**: `enterprise_id`, `project`, 年度用量 `amount_2020~2024`
- **索引**: `enterprise_id`/`project` 及时间索引

### 表：`pcb_enterprise`、`pcb_enterprises`
- **用途**: 企业基础信息（两套结构）
- **关键字段**: 名称/地区/联系方式/产能/状态等；`unified_social_credit_code` 唯一（在 `pcb_enterprises`）
- **索引**: 名称/状态/流程步/删除标记、时间索引；信用代码唯一

### 表：`pcb_enterprise_scheme`、`pcb_enterprise_schemes`
- **用途**: 企业选择与实施方案记录
- **关键字段**: `enterprise_id`, `scheme_id`, `indicator_id`, `status`, 实施计划/时间/成效
- **索引**: `enterprise_id`/`scheme_id`/`indicator_id` 与时间索引

### 表：`pcb_equipment_category`、`pcb_equipment_record`
- **用途**: 工艺装备分类与企业设备台账
- **关键字段**: 分类 `name`(唯一)；设备 `enterprise_id`, `equipment_name`, `process`, `status`
- **索引**: 分类名唯一；设备按企业/设备名及时间索引

### 表：`pcb_gas_consumption_record`
- **用途**: 天然气消耗记录
- **关键字段**: `enterprise_id`, `project`, 年度用量 `amount_2020~2024`
- **索引**: `enterprise_id`/`project` 及时间索引

### 表：`pcb_gas_emission_monitoring`
- **用途**: 废气排放监测
- **关键字段**: `enterprise_id`, `detection_point`, `detection_item`, 监测结果/限值等
- **索引**: `enterprise_id`/`detection_point` 及时间索引

### 表：`pcb_indicator`、`pcb_indicators`
- **用途**: 64项指标定义与扩展定义表
- **关键字段**: `indicator_id`(唯一), `name`, `category`, `indicator_type`, `unit`, `is_limiting`, `level_standards`
- **索引**: `indicator_id` 唯一；类型/类别/是否限定与时间索引

### 表：`pcb_indicator_scheme_relation`
- **用途**: 指标-方案多对多关联
- **关键字段**: `indicator_id`, `scheme_id`, `relevance_score`, `priority`
- **索引**: (`indicator_id`,`scheme_id`) 唯一；两端外键与时间索引

### 表：`pcb_leadership_team`
- **用途**: 审核领导小组
- **关键字段**: `enterprise_id`, `name`, `role`
- **索引**: (`enterprise_id`,`role`) 及时间索引

### 表：`pcb_material_catalog`
- **用途**: 材料名录与默认单位/别名
- **关键字段**: `name`(唯一), `default_unit`, `aliases`
- **索引**: 名称唯一与时间索引

### 表：`pcb_noise_monitoring`
- **用途**: 厂界噪声监测
- **关键字段**: `enterprise_id`, `monitoring_point`, 日/夜结果与标准
- **索引**: `enterprise_id`/`monitoring_point` 与时间索引

### 表：`pcb_organized_gas_monitoring`、`pcb_unorganized_gas_monitoring`
- **用途**: 有组织/无组织废气监测
- **关键字段**: `enterprise_id`, 监测点/时间及因子浓度
- **索引**: `enterprise_id`/监测点/监测因子 与时间索引

### 表：`pcb_output_value`
- **用途**: 产值与税收
- **关键字段**: `enterprise_id`, `year`(与企业唯一), `unit`, `annual_output_value`, `income_tax`
- **索引**: (`enterprise_id`,`year`) 唯一；`unit` 与时间索引

### 表：`pcb_pre_audit_data`
- **用途**: 预审核各模块JSON结构数据
- **关键字段**: `enterprise_id`, `status`, 各模块JSON
- **索引**: `enterprise_id`/`status` 与时间索引

### 表：`pcb_process_catalog`
- **用途**: 工序名录
- **关键字段**: `name`(唯一), `description`
- **索引**: 名称唯一与时间索引

### 表：`pcb_product_output`
- **用途**: 产品年产量结构化记录
- **关键字段**: (`enterprise_id`,`type`,`main_product`,`year`) 唯一；`output`, `layers`
- **索引**: 复合唯一；企业/年份/产品/类型与时间索引

### 表：`pcb_qualification_rate`
- **用途**: 年度合格率
- **关键字段**: (`enterprise_id`,`year`) 唯一；`rate`
- **索引**: 复合唯一；企业/年份与时间索引

### 表：`pcb_resource_consumption_summary`
- **用途**: 资源能源年度汇总与单位产品消耗
- **关键字段**: (`enterprise_id`,`year`) 唯一；水/电/气各分项与单位消耗
- **索引**: 复合唯一；`enterprise_id`/`year` 与时间索引

### 表：`pcb_scheme`、`pcb_schemes`
- **用途**: 清洁生产方案库（两套结构）
- **关键字段**: `scheme_id`(唯一, 在 `pcb_scheme`)/`scheme_number`(唯一, 在 `pcb_schemes`), `name`, 类型、效益、投资、回收期等
- **索引**: 编号唯一；`name`/`status` 与时间索引

### 表：`pcb_solid_waste_category`、`pcb_solid_waste_record`
- **用途**: 固体废物分类与企业固废记录
- **关键字段**: 类别 `name`(唯一)；记录 `enterprise_id`, `category`, `name`, 年度用量
- **索引**: 类别名唯一；记录按企业/类别/名称与时间索引

### 表：`pcb_training_records`、`pcb_training_images`
- **用途**: 培训记录与图片
- **关键字段**: 记录 `enterprise_id`, `date`；图片 `training_id`, `image_path`
- **索引**: (`enterprise_id`,`date`)；`training_id`

### 表：`pcb_waste_gas_analysis`
- **用途**: 废气产生分析（类型/部位/处理）
- **关键字段**: `enterprise_id`, `gas_type`, `pollutants`, `location`, `treatment`
- **索引**: 企业/气体类型 与时间索引

### 表：`pcb_wastewater_analysis`、`pcb_wastewater_monitoring`
- **用途**: 废水产生分析与监测
- **关键字段**: `enterprise_id`, `category`/`sampling_date`，典型监测指标如 `cod`, `total_copper` 等
- **索引**: 企业/类别/采样日期 与时间索引

### 表：`aerich`
- **用途**: 迁移版本记录（ORM工具表）
- **关键字段**: `version`, `app`, `content`
- **索引**: 默认主键

---

## 说明
- 本文档依据当前库实时结构生成；若后续有迁移或新表，请按同格式补充。
- 需要字段级详情时，可对目标表执行：`PRAGMA table_info('<table>')`、`PRAGMA index_list('<table>')`、`PRAGMA index_info('<index>')`。
