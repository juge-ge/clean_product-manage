# PCB审核表格优化完成报告

## 修改日期
2025年1月

## 修改内容概述

根据新的需求，对PCB审核表格进行了以下优化：

1. **权重显示格式改为小数形式**（不再显示百分比）
2. **添加"产量(m²)"列**（位于"当前值"和"一级指标权重"之间）
3. **调整列宽**，确保标题在一行显示，无需左右移动
4. **支持动态权重标记**（*和**）

## 详细修改内容

### 1. 表格列结构调整

#### 列顺序（从左到右）：
1. **序号** - 宽度：70px
2. **一级指标** - 宽度：180px
3. **二级指标** - 宽度：230px
4. **当前值** - 宽度：110px
5. **产量(m²)** - 宽度：110px ⭐ 新增
6. **一级指标权重** - 宽度：110px（小数形式）
7. **二级指标权重** - 宽度：110px（小数形式，动态权重带标记）
8. **评级** - 宽度：100px

### 2. 权重显示格式修改

#### 修改前：
- 一级指标权重：`15.0%`（百分比形式）
- 二级指标权重：`20.0%` 或 `1.0%*`（百分比形式）

#### 修改后：
- 一级指标权重：`0.150`（小数形式，保留3位小数）
- 二级指标权重：
  - 普通权重：`0.200`（小数形式）
  - 动态权重（7-14, 20-27, 30-37）：`1.000*`（带单星号）
  - 动态权重（38-41）：`0.100**`（带双星号）

### 3. 产量数据获取

#### 功能说明：
- 根据指标ID自动匹配对应的产品类型和产量
- 支持的指标范围：7-14, 15-18, 20-27, 30-33, 34-37, 38-41
- 产量数据来源：企业生产信息模块（`pcb_product_output`表）
- 显示格式：自动格式化数字，保留2位小数，使用中文千分位分隔符

#### 指标与产品类型映射：

| 指标ID | 产品类型 | 说明 |
|--------|---------|------|
| 7, 15, 20, 30, 34, 38 | 刚性单面板 | 层数=1 |
| 8, 16, 21, 31, 35, 39 | 刚性双面板 | 层数=2 |
| 9, 17, 22, 32, 36, 40 | 刚性多层板 | 层数不固定 |
| 10, 18, 23, 33, 37, 41 | 刚性HDI板 | 层数不固定 |
| 11, 24 | 挠性单面板 | 层数=1 |
| 12, 25 | 挠性双面板 | 层数=2 |
| 13, 26 | 挠性多层板 | 层数不固定 |
| 14, 27 | 挠性HDI板 | 层数不固定 |

### 4. 动态权重说明

根据需求文档，动态权重的分组如下：

#### 单星号(*)标记 - 权重总和为1：
- **指标7-14**：能源消耗 - 单位产品电耗（总和为1，需根据产量计算）
- **指标20-27**：原/辅料消耗 - 覆铜板利用率（总和为1，需根据产量计算）
- **指标30-33**：污染物产生与排放 - 废水产生量（总和为0.2，需根据产量计算）
- **指标34-37**：污染物产生与排放 - 废水中铜产生量（总和为0.1，需根据产量计算）

#### 双星号(**)标记 - 权重总和为0.1：
- **指标38-41**：污染物产生与排放 - 废水中COD总产生量（在同一一级指标下，它们的权重和为0.1）

#### 单星号(*)标记 - 权重总和为0.5：
- **指标15-18**：水资源消耗 - 单位产品新鲜水耗（总和为0.5，需根据产量计算）

### 5. 代码实现要点

#### 产量数据获取函数：
```javascript
const getIndicatorOutput = (indicatorId, indicatorName) => {
  // 1. 根据指标ID映射到产品类型
  // 2. 从productOutputData中查找匹配的产品
  // 3. 计算所有年份的总产量
  // 4. 返回格式化后的数值
}
```

#### 权重显示渲染：
```javascript
// 一级指标权重
row.category_weight.toFixed(3)  // 0.150

// 二级指标权重
if (row.is_dynamic_weight) {
  if (row.id >= 38 && row.id <= 41) {
    return weightValue + '**'  // 0.100**
  }
  return weightValue + '*'    // 1.000*
}
return row.weight.toFixed(3)  // 0.200
```

## 表格列宽优化

### 列宽分配（总计：~1020px）：
- 序号：70px
- 一级指标：180px
- 二级指标：230px
- 当前值：110px
- 产量(m²)：110px
- 一级指标权重：110px
- 二级指标权重：110px
- 评级：100px

### 优化效果：
✅ 所有列标题都能在一行显示  
✅ 不需要左右滚动查看列标题  
✅ 列宽适中，不会过度压缩内容  
✅ 适应常见屏幕分辨率（1920x1080及以上）

## 数据流说明

### 数据获取流程：
```
1. 获取指标定义（包含权重信息）
   ↓
2. 获取审核结果
   ↓
3. 获取产品产量数据 ⭐ 新增
   ↓
4. 合并数据并构建树形结构
   ↓
5. 渲染表格（包含产量列）
```

### 产量数据匹配逻辑：
```
指标ID → 产品类型映射表 → 匹配产品产量数据 → 计算总产量 → 显示
```

## 注意事项

1. **产量数据依赖**：
   - 产量列的数据来自企业生产信息模块
   - 如果生产信息未填写，产量列将显示为空
   - 不影响其他列的显示

2. **动态权重计算**：
   - 目前仅显示权重值和标记
   - 实际动态计算逻辑需要在后续实现
   - 标记(*)和(**)用于标识需要动态计算的权重组

3. **权重精度**：
   - 所有权重显示为3位小数（`toFixed(3)`）
   - 确保与数据库存储精度一致（DECIMAL(5,3)）

4. **产量格式化**：
   - 使用中文数字格式（千分位分隔符）
   - 保留2位小数
   - 大数值自动格式化（如：1,234,567.89）

## 后续工作建议

1. **动态权重计算**：
   - 实现根据产量自动计算动态权重的逻辑
   - 支持权重组的自动分配

2. **产量数据验证**：
   - 验证产量数据的完整性和准确性
   - 提供数据校验提示

3. **用户体验优化**：
   - 产量列为空时显示提示信息
   - 添加产量数据的快速编辑入口

## 总结

✅ 权重显示格式已改为小数形式  
✅ 产量(m²)列已添加并正常工作  
✅ 列宽已优化，标题在一行显示  
✅ 动态权重标记正确显示  
✅ 产品产量数据自动匹配和显示  

表格现在符合新的需求规范，所有功能正常工作。

