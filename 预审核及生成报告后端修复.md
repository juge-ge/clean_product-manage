# PCB预审核及生成报告后端修复文档

## 1. 概述

本文档详细分析了PCB清洁生产审核系统中预审核模块的完整架构、数据库设计、API接口以及前后端交互机制，并提供了报告生成功能的修复方案。

## 2. 预审核模块架构分析

### 2.1 整体架构

```
前端 (Vue 3) ←→ API层 (FastAPI) ←→ 控制器层 ←→ 数据模型层 ←→ 数据库 (SQLite)
```

### 2.2 核心组件

#### 2.2.1 前端组件结构
```
pre-audit.vue (主页面)
├── ProductionInfoForm.vue (企业总体生产情况)
├── RawMaterialForm.vue (原辅材料使用情况)
├── ProcessEquipmentForm.vue (主要工艺及装备使用)
├── ResourceConsumptionForm.vue (资源能源消耗)
├── PollutionControlForm.vue (污染防治)
├── SolidWasteForm.vue (工业固体废物管理)
└── SelfMonitoringForm.vue (自行监测情况)
```

#### 2.2.2 后端API结构
```
/api/v1/pcb/enterprise/{enterprise_id}/pre-audit
├── GET - 获取预审核数据
├── POST - 保存预审核数据
└── POST /submit - 提交预审核数据

/api/v1/pcb/enterprise/{enterprise_id}/production-data
├── GET - 获取生产情况数据
├── POST - 保存生产情况数据
├── PUT - 更新生产情况数据
└── DELETE - 删除生产情况数据

/api/v1/resource-consumption/enterprise/{enterprise_id}/all-data
├── GET - 获取资源消耗数据
├── POST - 保存资源消耗数据
└── DELETE - 删除资源消耗数据

/api/v1/process-equipment/enterprise/{enterprise_id}/all-data
├── GET - 获取设备数据
├── POST - 保存设备数据
└── DELETE - 删除设备数据

/api/v1/pollution-control/enterprise/{enterprise_id}/all-data
├── GET - 获取污染防治数据
├── POST - 保存污染防治数据
└── DELETE - 删除污染防治数据

/api/v1/solid-waste/enterprise/{enterprise_id}/all-data
├── GET - 获取固体废物数据
├── POST - 保存固体废物数据
└── DELETE - 删除固体废物数据

/api/v1/self-monitoring/enterprise/{enterprise_id}/all-data
├── GET - 获取自行监测数据
├── POST - 保存自行监测数据
└── DELETE - 删除自行监测数据
```

## 3. 数据库设计分析

### 3.1 核心表结构

#### 3.1.1 PCB预审核主表 (pcb_pre_audit_data)
```sql
CREATE TABLE pcb_pre_audit_data (
    id BIGINT PRIMARY KEY,
    enterprise_id BIGINT NOT NULL,
    
    -- 预审核数据（JSON格式存储）
    production_info JSON,           -- 企业总体生产情况
    raw_materials JSON,             -- 原辅材料使用情况
    process_equipment JSON,         -- 主要工艺及装备使用
    resource_consumption JSON,      -- 资源能源消耗
    pollution_control JSON,         -- 污染防治
    solid_waste JSON,               -- 工业固体废物管理
    self_monitoring JSON,           -- 自行监测情况
    
    -- 提交状态
    status VARCHAR(50) DEFAULT 'draft',  -- draft(草稿), submitted(已提交), approved(已审核)
    submitted_at DATETIME,
    approved_at DATETIME,
    
    created_at DATETIME,
    updated_at DATETIME
);
```

#### 3.1.2 生产情况相关表
```sql
-- 产品产量表
CREATE TABLE pcb_product_output (
    id BIGINT PRIMARY KEY,
    enterprise_id BIGINT NOT NULL,
    type VARCHAR(50),               -- 类型(rigid/flexible)
    main_product VARCHAR(100),      -- 主要产品
    unit VARCHAR(50),               -- 单位
    year VARCHAR(10),               -- 年份
    output DECIMAL(15,2),           -- 产量
    layers INT,                     -- 层数
    created_at DATETIME,
    updated_at DATETIME
);

-- 合格率表
CREATE TABLE pcb_qualification_rate (
    id BIGINT PRIMARY KEY,
    enterprise_id BIGINT NOT NULL,
    year VARCHAR(10),               -- 年份
    rate DECIMAL(5,2),              -- 合格率(%)
    created_at DATETIME,
    updated_at DATETIME
);

-- 产值情况表
CREATE TABLE pcb_output_value (
    id BIGINT PRIMARY KEY,
    enterprise_id BIGINT NOT NULL,
    year VARCHAR(10),               -- 年份
    unit VARCHAR(50),               -- 单位
    annual_output_value DECIMAL(15,2), -- 年产值
    income_tax DECIMAL(15,2),       -- 所得税
    created_at DATETIME,
    updated_at DATETIME
);
```

#### 3.1.3 资源消耗相关表
```sql
-- 用水消耗记录表
CREATE TABLE pcb_water_consumption_record (
    id BIGINT PRIMARY KEY,
    enterprise_id BIGINT NOT NULL,
    project VARCHAR(100),           -- 项目名称
    year VARCHAR(10),               -- 年份
    consumption DECIMAL(15,2),      -- 消耗量
    unit VARCHAR(50),               -- 单位
    created_at DATETIME,
    updated_at DATETIME
);

-- 用电消耗记录表
CREATE TABLE pcb_electricity_consumption_record (
    id BIGINT PRIMARY KEY,
    enterprise_id BIGINT NOT NULL,
    project VARCHAR(100),           -- 项目名称
    year VARCHAR(10),               -- 年份
    consumption DECIMAL(15,2),      -- 消耗量
    unit VARCHAR(50),               -- 单位
    created_at DATETIME,
    updated_at DATETIME
);

-- 天然气消耗记录表
CREATE TABLE pcb_gas_consumption_record (
    id BIGINT PRIMARY KEY,
    enterprise_id BIGINT NOT NULL,
    project VARCHAR(100),           -- 项目名称
    year VARCHAR(10),               -- 年份
    consumption DECIMAL(15,2),      -- 消耗量
    unit VARCHAR(50),               -- 单位
    created_at DATETIME,
    updated_at DATETIME
);
```

#### 3.1.4 污染防治相关表
```sql
-- 废水分析表
CREATE TABLE pcb_wastewater_analysis (
    id BIGINT PRIMARY KEY,
    enterprise_id BIGINT NOT NULL,
    analysis_date DATE,             -- 分析日期
    ph_value DECIMAL(5,2),          -- pH值
    cod_value DECIMAL(10,2),        -- COD值
    bod_value DECIMAL(10,2),        -- BOD值
    ss_value DECIMAL(10,2),         -- SS值
    created_at DATETIME,
    updated_at DATETIME
);

-- 废气分析表
CREATE TABLE pcb_waste_gas_analysis (
    id BIGINT PRIMARY KEY,
    enterprise_id BIGINT NOT NULL,
    analysis_date DATE,             -- 分析日期
    so2_value DECIMAL(10,2),        -- SO2值
    nox_value DECIMAL(10,2),        -- NOx值
    dust_value DECIMAL(10,2),       -- 粉尘值
    created_at DATETIME,
    updated_at DATETIME
);
```

#### 3.1.5 设备相关表
```sql
-- 设备记录表
CREATE TABLE pcb_equipment_record (
    id BIGINT PRIMARY KEY,
    enterprise_id BIGINT NOT NULL,
    equipment_name VARCHAR(200),    -- 设备名称
    equipment_type VARCHAR(100),    -- 设备类型
    model VARCHAR(100),             -- 型号
    manufacturer VARCHAR(200),      -- 制造商
    purchase_date DATE,             -- 购买日期
    status VARCHAR(50),             -- 状态
    created_at DATETIME,
    updated_at DATETIME
);
```

#### 3.1.6 固体废物相关表
```sql
-- 固体废物记录表
CREATE TABLE pcb_solid_waste_record (
    id BIGINT PRIMARY KEY,
    enterprise_id BIGINT NOT NULL,
    waste_name VARCHAR(200),        -- 废物名称
    waste_type VARCHAR(100),        -- 废物类型
    quantity DECIMAL(15,2),         -- 数量
    unit VARCHAR(50),               -- 单位
    disposal_method VARCHAR(200),   -- 处置方式
    created_at DATETIME,
    updated_at DATETIME
);
```

#### 3.1.7 自行监测相关表
```sql
-- 有组织废气监测表
CREATE TABLE pcb_organized_gas_monitoring (
    id BIGINT PRIMARY KEY,
    enterprise_id BIGINT NOT NULL,
    monitoring_date DATE,           -- 监测日期
    monitoring_point VARCHAR(100),  -- 监测点位
    so2_value DECIMAL(10,2),        -- SO2值
    nox_value DECIMAL(10,2),        -- NOx值
    dust_value DECIMAL(10,2),       -- 粉尘值
    created_at DATETIME,
    updated_at DATETIME
);

-- 无组织废气监测表
CREATE TABLE pcb_unorganized_gas_monitoring (
    id BIGINT PRIMARY KEY,
    enterprise_id BIGINT NOT NULL,
    monitoring_date DATE,           -- 监测日期
    monitoring_point VARCHAR(100),  -- 监测点位
    so2_value DECIMAL(10,2),        -- SO2值
    nox_value DECIMAL(10,2),        -- NOx值
    dust_value DECIMAL(10,2),       -- 粉尘值
    created_at DATETIME,
    updated_at DATETIME
);

-- 废水监测表
CREATE TABLE pcb_wastewater_monitoring (
    id BIGINT PRIMARY KEY,
    enterprise_id BIGINT NOT NULL,
    monitoring_date DATE,           -- 监测日期
    monitoring_point VARCHAR(100),  -- 监测点位
    ph_value DECIMAL(5,2),          -- pH值
    cod_value DECIMAL(10,2),        -- COD值
    bod_value DECIMAL(10,2),        -- BOD值
    ss_value DECIMAL(10,2),         -- SS值
    created_at DATETIME,
    updated_at DATETIME
);

-- 噪声监测表
CREATE TABLE pcb_noise_monitoring (
    id BIGINT PRIMARY KEY,
    enterprise_id BIGINT NOT NULL,
    monitoring_date DATE,           -- 监测日期
    monitoring_point VARCHAR(100),  -- 监测点位
    noise_level DECIMAL(5,2),       -- 噪声值
    unit VARCHAR(50),               -- 单位
    created_at DATETIME,
    updated_at DATETIME
);
```

## 4. 前后端交互机制

### 4.1 数据流向

```
1. 前端页面加载
   ↓
2. 调用 fetchPreAuditData()
   ↓
3. 并行调用多个API获取数据:
   - api.pcb.production.getData() → 生产情况数据
   - api.pcb.preAudit.getData() → 其他预审核数据
   ↓
4. 数据合并到 formData.value
   ↓
5. 各子组件接收数据并渲染
```

### 4.2 数据保存机制

#### 4.2.1 模块暂存
```javascript
// 每个模块都有独立的暂存按钮
const saveModuleData = async (moduleName) => {
  if (moduleName === 'productionInfo') {
    await api.pcb.production.saveData(props.enterpriseId, formData.value.productionInfo)
  } else if (moduleName === 'resourceConsumption') {
    await resourceConsumptionFormRef.value.saveData()
  } else if (moduleName === 'processEquipment') {
    await api.pcb.processEquipment.saveAllData(props.enterpriseId, formData.value.processEquipment)
  }
  // ... 其他模块
}
```

#### 4.2.2 整体保存
```javascript
const handleSaveDraft = async () => {
  // 保存生产情况数据
  await api.pcb.production.saveData(props.enterpriseId, formData.value.productionInfo)
  
  // 保存其他预审核数据
  await api.pcb.preAudit.saveData(props.enterpriseId, formData.value)
}
```

### 4.3 API调用映射

| 前端模块 | API端点 | 控制器 | 数据库表 |
|---------|---------|--------|----------|
| 企业总体生产情况 | `/pcb/enterprise/{id}/production-data` | `PCBProductionDataController` | `pcb_product_output`, `pcb_qualification_rate`, `pcb_output_value` |
| 原辅材料使用情况 | `/pcb/enterprise/{id}/pre-audit` | `PCBPreAuditDataController` | `pcb_pre_audit_data.raw_materials` |
| 主要工艺及装备使用 | `/process-equipment/enterprise/{id}/all-data` | `PCBEquipmentDataController` | `pcb_equipment_record` |
| 资源能源消耗 | `/resource-consumption/enterprise/{id}/all-data` | `PCBResourceConsumptionDataController` | `pcb_water_consumption_record`, `pcb_electricity_consumption_record`, `pcb_gas_consumption_record` |
| 污染防治 | `/pollution-control/enterprise/{id}/all-data` | `PCBPollutionControlDataController` | `pcb_wastewater_analysis`, `pcb_waste_gas_analysis` |
| 工业固体废物管理 | `/solid-waste/enterprise/{id}/all-data` | `PCBSolidWasteDataController` | `pcb_solid_waste_record` |
| 自行监测情况 | `/self-monitoring/enterprise/{id}/all-data` | `PCBSelfMonitoringDataController` | `pcb_organized_gas_monitoring`, `pcb_unorganized_gas_monitoring`, `pcb_wastewater_monitoring`, `pcb_noise_monitoring` |

## 5. 报告生成功能分析

### 5.1 报告生成架构

```
前端请求 → API端点 → 报告生成器 → 数据收集 → Word文档生成 → 文件返回
```

### 5.2 报告生成流程

#### 5.2.1 API端点
```python
@router.get("/enterprise/{enterprise_id}/report/generate")
async def generate_audit_report(enterprise_id: int, current_user = DependAuth):
    """生成PCB清洁生产审核报告"""
    try:
        report_path = await report_generator.generate_report(enterprise_id)
        return Success(
            data={
                "report_path": report_path,
                "report_filename": os.path.basename(report_path)
            },
            msg="报告生成成功"
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"报告生成失败: {str(e)}")
```

#### 5.2.2 报告生成器
```python
class PCBReportGenerator:
    async def generate_report(self, enterprise_id: int) -> str:
        """生成完整的PCB审核报告"""
        # 1. 获取企业信息
        enterprise = await PCBEnterprise.get_or_none(id=enterprise_id)
        
        # 2. 获取筹划与组织数据
        leadership_team = await PCBLeadershipTeam.filter(enterprise_id=enterprise_id)
        work_team = await PCBWorkTeam.filter(enterprise_id=enterprise_id)
        work_plans = await PCBWorkPlan.filter(enterprise_id=enterprise_id)
        training_records = await PCBTrainingRecord.filter(enterprise_id=enterprise_id)
        
        # 3. 获取预审核数据
        pre_audit_data = await PCBPreAuditData.get_or_none(enterprise_id=enterprise_id)
        
        # 4. 获取审核结果
        audit_results = await PCBAuditResult.filter(enterprise_id=enterprise_id)
        
        # 5. 生成Word文档
        doc = Document()
        self._generate_cover_page(doc, enterprise)
        self._generate_enterprise_info(doc, enterprise)
        self._generate_planning_organization(doc, leadership_team, work_team, work_plans, training_records)
        self._generate_pre_audit_data(doc, pre_audit_data)
        await self._generate_audit_results(doc, audit_results)
        
        # 6. 保存文档
        filename = f"PCB清洁生产审核报告_{enterprise.name}_{datetime.now().strftime('%Y%m%d')}.docx"
        filepath = os.path.join("reports", filename)
        doc.save(filepath)
        
        return filepath
```

### 5.3 报告内容结构

1. **封面页**: 企业名称、报告标题、生成日期
2. **企业信息**: 基本信息、联系方式、产能等
3. **筹划与组织**: 领导小组、工作小组、工作计划、培训记录
4. **预审核数据**: 7个模块的详细数据表格
5. **审核结果**: 64项指标的审核结果和评分
6. **改进建议**: 基于审核结果的改进方案

## 6. 已修复的问题

### 6.1 JSON序列化错误
**问题**: `TypeError: Object of type date is not JSON serializable`
**修复**: 在`app/models/base.py`中添加对`date`类型的支持
```python
elif isinstance(value, date):
    value = value.strftime('%Y-%m-%d')
```

### 6.2 API返回格式统一
**问题**: 控制器返回Pydantic模型，无法被JSON序列化
**修复**: 将所有控制器的`get_all_data`方法改为返回字典格式
```python
# 转换为字典列表
data_list = [await record.to_dict() for record in records]
return {"data": data_list}
```

### 6.3 报告生成异步问题
**问题**: `SyntaxError: 'await' outside async function`
**修复**: 将`_generate_audit_results`方法改为异步方法
```python
async def _generate_audit_results(self, doc, audit_results):
    # 异步处理审核结果
```

### 6.4 依赖注入问题
**问题**: `TypeError: Depends(is_authed) is not a callable object`
**修复**: 使用正确的依赖注入语法
```python
current_user = DependAuth  # 而不是 Depends(DependAuth)
```

## 7. 当前状态

### 7.1 已验证正常工作的功能
- ✅ 企业信息API
- ✅ 报告数据API
- ✅ 报告生成Word文档API
- ✅ 污染防治数据API
- ✅ 设备数据API
- ✅ 固体废物数据API
- ✅ 自行监测数据API

### 7.2 需要进一步调试的功能
- ⚠️ 生产数据API (返回500错误)
- ⚠️ 资源消耗API (返回500错误)

### 7.3 报告生成功能
- ✅ 报告生成器已实现
- ✅ Word文档生成正常
- ✅ 文件保存到`reports/`目录
- ✅ 包含完整的企业数据

## 8. 技术规范

### 8.1 数据存储规范
- 主表使用JSON字段存储复杂数据结构
- 子表使用关系型存储详细记录
- 所有表都包含`created_at`和`updated_at`时间戳

### 8.2 API设计规范
- 使用RESTful风格
- 统一的响应格式：`{"code": 200, "message": "成功", "data": {...}}`
- 统一的错误处理
- 支持分页查询

### 8.3 前端交互规范
- 使用Vue 3 Composition API
- 响应式数据管理
- 模块化组件设计
- 统一的API调用层

### 8.4 报告生成规范
- 使用`python-docx`库生成Word文档
- 遵循公文格式要求
- 数据以表格形式呈现
- 支持中文字体

## 9. 建议的下一步操作

### 9.1 调试剩余API
1. 查看服务器日志了解生产数据和资源消耗API的具体错误
2. 使用Swagger UI测试API端点
3. 检查数据库连接和模型配置

### 9.2 前端功能测试
1. 在浏览器中打开前端界面
2. 测试所有数据录入功能
3. 验证数据保存和显示
4. 测试报告生成和下载

### 9.3 数据完整性验证
1. 确认深圳市鑫满达公司（ID: 11）的所有数据
2. 验证预审核数据的完整性
3. 检查报告生成的数据准确性

## 10. 总结

PCB预审核模块采用了模块化设计，将复杂的预审核数据分解为7个独立的功能模块，每个模块都有对应的数据库表和API接口。通过JSON字段和关系型表的结合，实现了灵活的数据存储和高效的数据查询。

报告生成功能已经完整实现，能够自动收集企业信息、筹划与组织、预审核和审核数据，生成符合公文格式要求的Word文档。

虽然还有少数API端点需要进一步调试，但整体架构已经稳定，核心功能已经可用。建议通过前端界面进行完整的功能测试，确保所有增删改查操作都能正常工作。
