# PCB预审核模块前后端交互解决方案

## 1. 项目概述

本文档总结了PCB清洁生产审核系统中预审核模块的前后端交互开发过程，包括遇到的问题、解决方案以及最佳实践。

## 2. 模块架构

### 2.1 后端架构
- **框架**: FastAPI + Tortoise ORM
- **数据库**: MySQL
- **API路由**: `/api/v1/pcb/enterprise/{enterprise_id}/pre-audit`
- **控制器**: `PCBPreAuditDataController`

### 2.2 前端架构
- **框架**: Vue 3 + Composition API
- **UI库**: Naive UI
- **状态管理**: 响应式数据
- **API调用**: Axios + 统一API服务层

## 3. 主要功能模块

### 3.1 企业生产情况数据管理
- 获取企业生产情况数据
- 保存/更新生产数据
- 数据验证和格式化

### 3.2 原辅材料管理
- 原辅材料列表管理
- 材料信息CRUD操作
- 材料分类和属性管理

## 4. 遇到的问题及解决方案

### 4.1 API路由注册问题

**问题描述**:
在注册新的API路由时，出现模块导入错误和路由冲突。

**错误信息**:
```
ModuleNotFoundError: No module named 'app.api.v1.pcb_production'
ImportError: cannot import name 'router' from 'app.api.v1.raw_material'
```

**解决方案**:
1. **创建缺失的API模块文件**:
   ```python
   # app/api/v1/pcb_production.py
   from fastapi import APIRouter
   from app.controllers.pcb_production import PCBProductionController
   
   router = APIRouter()
   controller = PCBProductionController()
   
   @router.get("/enterprise/{enterprise_id}/production-data")
   async def get_production_data(enterprise_id: int):
       return await controller.get_by_enterprise(enterprise_id)
   ```

2. **修正导入语句**:
   ```python
   # app/api/v1/__init__.py
   from .pcb_production import router as pcb_production_router
   from .raw_material import router as raw_material_router
   ```

3. **正确注册路由**:
   ```python
   v1_router.include_router(pcb_production_router, prefix="/pcb", dependencies=[DependPermission])
   v1_router.include_router(raw_material_router, prefix="/raw-material", dependencies=[DependPermission])
   ```

### 4.2 前端API服务层扩展

**问题描述**:
前端需要调用新的后端API，但API服务层缺少相应的接口定义。

**解决方案**:
1. **扩展PCB API服务**:
   ```javascript
   // web/src/api/pcb.js
   
   // PCB企业生产情况数据API
   export const pcbProductionApi = {
     getData: (enterpriseId) => 
       request.get(`/pcb/enterprise/${enterpriseId}/production-data`),
     saveData: (enterpriseId, data) => 
       request.post(`/pcb/enterprise/${enterpriseId}/production-data`, data),
     updateData: (enterpriseId, data) => 
       request.put(`/pcb/enterprise/${enterpriseId}/production-data`, data),
     deleteData: (enterpriseId) => 
       request.delete(`/pcb/enterprise/${enterpriseId}/production-data`)
   }
   
   // 原辅材料API
   export const rawMaterialApi = {
     getMaterials: (params = {}) => request.get('/raw-material/materials', { params }),
     create: (data) => request.post('/raw-material/materials', data),
     getDetail: (id) => request.get(`/raw-material/materials/${id}`),
     update: (id, data) => request.put(`/raw-material/materials/${id}`, data),
     delete: (id) => request.delete(`/raw-material/materials/${id}`)
   }
   ```

2. **更新统一API对象**:
   ```javascript
   export default {
     // ... 其他API
     production: pcbProductionApi,
     rawMaterial: rawMaterialApi
   }
   ```

### 4.3 数据模型定义问题

**问题描述**:
新的功能模块需要对应的数据模型，但模型定义不完整或字段映射错误。

**解决方案**:
1. **创建数据模型**:
   ```python
   # app/models/pcb_production.py
   from tortoise.models import Model
   from tortoise import fields
   
   class PCBProductionData(Model):
       id = fields.IntField(pk=True)
       enterprise_id = fields.IntField()
       production_capacity = fields.FloatField(null=True)
       actual_production = fields.FloatField(null=True)
       # ... 其他字段
       
       class Meta:
           table = "pcb_production_data"
   ```

2. **创建Pydantic模式**:
   ```python
   # app/schemas/pcb_production.py
   from pydantic import BaseModel
   from typing import Optional
   
   class PCBProductionDataCreate(BaseModel):
       enterprise_id: int
       production_capacity: Optional[float] = None
       actual_production: Optional[float] = None
   
   class PCBProductionDataUpdate(BaseModel):
       production_capacity: Optional[float] = None
       actual_production: Optional[float] = None
   ```

### 4.4 控制器实现问题

**问题描述**:
控制器方法实现不完整，缺少必要的业务逻辑。

**解决方案**:
1. **实现完整的控制器**:
   ```python
   # app/controllers/pcb_production.py
   from app.core.crud import CRUDBase
   from app.models.pcb_production import PCBProductionData
   from app.schemas.pcb_production import PCBProductionDataCreate, PCBProductionDataUpdate
   
   class PCBProductionController(CRUDBase[PCBProductionData, PCBProductionDataCreate, PCBProductionDataUpdate]):
       def __init__(self):
           super().__init__(model=PCBProductionData)
       
       async def get_by_enterprise(self, enterprise_id: int):
           """根据企业ID获取生产数据"""
           return await self.model.get_or_none(enterprise_id=enterprise_id)
       
       async def update_or_create(self, enterprise_id: int, data: dict):
           """更新或创建生产数据"""
           instance = await self.get_by_enterprise(enterprise_id)
           if instance:
               return await self.update(instance.id, data)
           else:
               data['enterprise_id'] = enterprise_id
               return await self.create(data)
   ```

## 5. 开发最佳实践

### 5.1 API设计原则
1. **RESTful设计**: 遵循REST API设计规范
2. **统一响应格式**: 使用统一的成功/错误响应格式
3. **参数验证**: 使用Pydantic进行请求参数验证
4. **错误处理**: 实现完善的错误处理机制

### 5.2 前端开发规范
1. **API服务层**: 统一管理所有API调用
2. **错误处理**: 统一的错误处理和用户提示
3. **数据验证**: 前端表单验证和后端数据验证
4. **用户体验**: 加载状态、操作反馈等

### 5.3 数据库设计
1. **字段命名**: 使用下划线命名法
2. **索引优化**: 为常用查询字段添加索引
3. **外键关系**: 正确设置表间关系
4. **数据完整性**: 设置必要的约束条件

## 6. 测试验证

### 6.1 后端API测试
```python
# 测试生产数据API
async def test_production_data_api():
    # 测试获取数据
    response = await client.get("/api/v1/pcb/enterprise/1/production-data")
    assert response.status_code == 200
    
    # 测试保存数据
    data = {"production_capacity": 1000.0, "actual_production": 800.0}
    response = await client.post("/api/v1/pcb/enterprise/1/production-data", json=data)
    assert response.status_code == 200
```

### 6.2 前端功能测试
```javascript
// 测试API调用
const testProductionAPI = async () => {
  try {
    // 获取数据
    const data = await api.pcb.production.getData(1);
    console.log('生产数据:', data);
    
    // 保存数据
    const result = await api.pcb.production.saveData(1, {
      production_capacity: 1000,
      actual_production: 800
    });
    console.log('保存结果:', result);
  } catch (error) {
    console.error('API测试失败:', error);
  }
};
```

## 7. 部署注意事项

### 7.1 数据库迁移
1. 确保新表结构正确创建
2. 验证外键关系
3. 检查索引是否生效

### 7.2 环境配置
1. 更新API路由配置
2. 检查权限设置
3. 验证跨域配置

### 7.3 监控和日志
1. 添加API调用日志
2. 监控错误率
3. 性能指标跟踪

## 8. 后续优化建议

### 8.1 性能优化
1. 数据库查询优化
2. 缓存机制引入
3. 分页加载实现

### 8.2 功能扩展
1. 数据导入导出
2. 批量操作支持
3. 数据统计分析

### 8.3 用户体验
1. 操作引导优化
2. 错误提示改进
3. 响应速度提升

## 9. 总结

通过本次预审核模块的开发，我们成功解决了以下关键问题：

1. **模块化架构**: 建立了清晰的前后端分离架构
2. **API标准化**: 实现了统一的API设计规范
3. **错误处理**: 完善了错误处理和用户反馈机制
4. **数据验证**: 实现了前后端双重数据验证
5. **开发效率**: 建立了可复用的开发模式

这些解决方案为后续模块开发提供了良好的参考和基础，确保了系统的可维护性和扩展性。

---

**文档版本**: v1.0  
**最后更新**: 2025-01-14  
**维护人员**: 开发团队
