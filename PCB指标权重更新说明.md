# PCB指标权重更新说明

## 更新内容

根据新的权重体系，对PCB审核模块的指标权重进行了以下更新：

1. **新增一级指标权重字段** (`category_weight`)
2. **更新二级指标权重字段** (`weight`)，精度调整为3位小数
3. **新增动态权重标记字段** (`is_dynamic_weight`)，标记需要根据产量动态计算的指标

## 权重体系说明

### 一级指标权重（category_weight）

| 一级指标 | 权重 |
|---------|------|
| 生产工艺与装备要求 | 0.15 |
| 能源消耗 | 0.1 |
| 水资源消耗 | 0.1 |
| 原/辅料消耗 | 0.1 |
| 资源综合利用 | 0.1 |
| 污染物产生与排放 | 0.2 |
| 温室气体排放 | 0.05 |
| 产品特征 | 0.1 |
| 清洁生产管理 | 0.1 |

### 动态权重说明

带`*`标记的指标权重需要根据企业实际产量动态计算：

- **1***：表示该组多项指标权重总和为1，需要根据各产品产量分配权重
  - 序号7-14：能源消耗（刚性/挠性各4种产品类型）
  - 序号20-27：覆铜板利用率（刚性/挠性各4种产品类型）
  
- **0.5***：表示该组多项指标权重总和为0.5，需要根据各产品产量分配权重
  - 序号15-18：单位产品新鲜水耗（4种产品类型）
  
- **0.2***：表示该组多项指标权重总和为0.2，需要根据各产品产量分配权重
  - 序号30-33：废水产生量（4种产品类型）
  
- **0.1***：表示该组多项指标权重总和为0.1，需要根据各产品产量分配权重
  - 序号34-37：废水中铜产生量（4种产品类型）
  - 序号38-41：废水中COD总产生量（4种产品类型，标记为0.1**）

## 执行步骤

### 1. 执行数据库字段迁移

首先添加新的字段到数据库：

```bash
python migrations/add_indicator_weight_fields.py
```

此脚本会：
- 添加 `category_weight` 字段（DECIMAL(5,3)）
- 添加 `is_dynamic_weight` 字段（BOOLEAN）
- 验证字段是否成功添加

### 2. 更新指标权重值

然后运行权重更新脚本：

```bash
python migrations/update_pcb_indicator_weights.py
```

此脚本会：
- 更新所有64项指标的一级权重（category_weight）
- 更新所有64项指标的二级权重（weight）
- 标记需要动态计算的指标（is_dynamic_weight=True）
- 显示更新结果和验证信息

### 3. 验证更新结果

运行更新脚本后，会显示：
- 成功更新的指标数量
- 未找到的指标数量
- 各一级指标的权重分布

## 动态权重计算说明

对于标记为 `is_dynamic_weight=True` 的指标，其实际权重需要根据企业各产品类型的产量进行动态计算：

### 计算公式

假设某组指标的总权重为 `W_total`，包含 `n` 种产品类型，各产品的产量分别为 `O1, O2, ..., On`，则：

1. 计算总产量：`O_total = O1 + O2 + ... + On`
2. 计算各产品产量占比：`R_i = O_i / O_total`
3. 计算各指标的动态权重：`W_i = W_total * R_i`

### 示例

对于能源消耗指标（序号7-14，总权重为1）：
- 如果企业只生产刚性单面板，则指标7的权重 = 1.0 * 1.0 = 1.0
- 如果企业生产刚性单面板和双面板，产量分别为60%和40%，则：
  - 指标7的权重 = 1.0 * 0.6 = 0.6
  - 指标8的权重 = 1.0 * 0.4 = 0.4

## 注意事项

1. **权重总和验证**：
   - 各一级指标下的二级指标权重总和应该为1.0
   - 例如：生产工艺与装备要求的6个二级指标权重：0.2+0.2+0.15+0.15+0.15+0.15 = 1.0

2. **动态权重处理**：
   - 前端或后端需要根据企业实际产品产量计算动态权重
   - 只有实际生产的产品类型对应的指标才参与评分

3. **数据库字段精度**：
   - `category_weight` 和 `weight` 字段精度为 DECIMAL(5,3)，支持3位小数
   - 示例：0.15, 0.1, 0.05, 0.2 等

## 修改的文件

1. **app/models/pcb.py**
   - 添加 `category_weight` 字段
   - 添加 `is_dynamic_weight` 字段
   - 更新 `weight` 字段的精度说明

2. **migrations/add_indicator_weight_fields.py**
   - 数据库字段迁移脚本

3. **migrations/update_pcb_indicator_weights.py**
   - 指标权重数据更新脚本

## 后续工作

1. 前端界面需要显示一级指标权重
2. 实现动态权重的计算逻辑
3. 在审核评分时应用动态权重
4. 更新审核报告生成逻辑，包含权重信息

